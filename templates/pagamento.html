<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pagamento - SmartCart</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bartle&family=BBH+Sans+Hegarty&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/pagamento.css') }}"
    />
  </head>
  <body>
    <a class="voltar" href="/pedidos"
      ><img src="/static/img/Seta.png" alt=""
    /></a>

    <div class="payment-wrapper">
      <!-- Lado Esquerdo: Área de Pagamento -->
      <div class="payment-main">
        <!-- Seleção de Método -->
        <div class="method-tabs">
          <button class="tab-btn active" onclick="switchTab('pix')">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path
                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
              ></path>
            </svg>
            Pix
          </button>
          <button class="tab-btn" onclick="switchTab('card')">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            Cartão de Crédito
          </button>
        </div>

        <!-- Conteúdo PIX -->
        <div id="tab-pix" class="tab-content active">
          <div class="pix-header">
            <h1>Pagamento via Pix</h1>
            <p>Escaneie o QR Code ou copie o código.</p>
          </div>

          <div class="qr-container">
            <img
              src="{{ qr_code_url }}"
              alt="QR Code Pix"
              onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ExemploPixSmartCart'"
            />
          </div>


          <button class="btn-action" onclick="copiarCodigo()">
            Copiar Código Pix
          </button>
        </div>

        <!-- Conteúdo CARTÃO -->
        <div id="tab-card" class="tab-content">
          <div class="pix-header">
            <h1>Dados do Cartão</h1>
            <p>Preencha os dados para finalizar.</p>
          </div>
s
          <form class="card-form">
            <div class="form-group">
                <label>Número do Cartão</label>
                <input 
                    type="text" 
                    placeholder="0000 0000 0000 0000" 
                    id="cartao" 
                    class="campo-obrigatorio" 
                    maxlength="19"
                    required 
                />
            </div>
        
            <div class="form-group">
                <label>Nome no Cartão</label>
                <input 
                    type="text" 
                    placeholder="Como impresso no cartão" 
                    class="campo-obrigatorio" 
                    required 
                />
            </div>
        
            <div class="form-row">
                <div class="form-group" style="flex: 1">
                    <label>Validade</label>
                    <input 
                        type="text" 
                        placeholder="MM/AA" 
                        id="validade" 
                        class="campo-obrigatorio" 
                        maxlength="5"
                        required 
                    />
                </div>
                <div class="form-group" style="flex: 1">
                    <label>CVV</label>
                    <input 
                        type="text" 
                        placeholder="123" 
                        maxlength="3" 
                        id="cvv" 
                        class="campo-obrigatorio" 
                        required 
                    />
                </div>
            </div>
        
            <button 
                class="btn-action btn-pay" 
                style="max-width: 100%; margin-top: 10px" 
                onclick="window.location.href=('/pedidos')" 
                id="btn-pagar" 
                disabled
            >
                {{ pedido.preco_unitario * pedido.quantidade}}
            </button>
        </form>
        </div>
      </div>

      <!-- Lado Direito: Resumo -->
       
      <div class="payment-summary">
        <h2 class="summary-title">Resumo do Pedido</h2>

        <div class="summary-row">
          <span>Produto</span>
          <strong>{{ pedido.nome_produto }}</strong>
        </div>

        <div class="summary-row">
          <span>Quantidade</span>
          <strong>{{ pedido.quantidade }} un</strong>
        </div>

        <div class="summary-row total">
          <span class="total-label">Valor Total a Pagar</span>
          <span class="value valor-para-formatar"> {{ pedido.preco_unitario * pedido.quantidade }} </span>
        </div>

        <div class="secure-badge">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          Ambiente Seguro
        </div>
      </div>
    </div>

    <script>
      let catao = document.getElementById("cartao");

      cartao.addEventListener("input", () => {
        let n = cartao.value.replace(/\D/g, "");

        n = n.substring(0, 16);

        if (n.length > 12) {
          n = n.replace(/(\d{4})(\d{4})(\d{4})(\d{0,4})/, "$1 $2 $3 $4");
        } else if (n.length > 8) {
          n = n.replace(/(\d{4})(\d{4})(\d{0,4})/, "$1 $2 $3");
        } else if (n.length > 4) {
          n = n.replace(/(\d{4})(\d{0,4})/, "$1 $2");
        } else if (n.length > 0) {
          n = n;
        } else {
          n = "";
        }

        catao.value = n;
      });

      let validade = document.getElementById("validade");

      validade.addEventListener("input", () => {
        let n = validade.value.replace(/\D/g, "");

        n = n.substring(0, 4);

        if (n.length > 2) {
          n = n.replace(/(\d{2})(\d{0,2})/, "$1/$2");
        }  else if (n.length > 0) {
          n = n;
        } else {
          n = "";
        }
        

        validade.value = n;
      });


      // Função para trocar abas
      function switchTab(tabName) {
        // Remove active de todos os botões e conteúdos
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        // Adiciona active no selecionado
        const selectedBtn = event.currentTarget; // Botão clicado
        selectedBtn.classList.add("active");

        document.getElementById("tab-" + tabName).classList.add("active");
      }

      function copiarCodigo() {
        navigator.clipboard.writeText(
          "00020126580014br.gov.bcb.pix0136123e4567..."
        );
        const btn = document.querySelector("#tab-pix .btn-action");
        const originalText = btn.innerText;

        btn.innerText = "Copiado!";
        btn.style.backgroundColor = "#8b9a5c";

        setTimeout(() => {
          btn.innerText = originalText;
          btn.style.backgroundColor = ""; // Volta ao CSS original
        }, 2000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        // 1. Seleciona todos os elementos que têm o preço
        const elementosPreco = document.querySelectorAll(".valor-para-formatar");
    
        // 2. Formatador padrão brasileiro (R$)
        const formatador = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        });
    
        // 3. Passa por cada pedido e formata o valor
        elementosPreco.forEach((elemento) => {
          // Pega o texto que veio do Python (ex: "1500.0" ou "1500.5")
          let valorTexto = elemento.innerText;
    
          // Converte para número decimal
          let valorNumerico = parseFloat(valorTexto);
    
          // Se for um número válido, substitui o texto pelo valor formatado (ex: R$ 1.500,50)
          if (!isNaN(valorNumerico)) {
            elemento.innerText = formatador.format(valorNumerico);
          }
        });
      });

      document.addEventListener("DOMContentLoaded", () => {
    // --- CONFIGURAÇÃO ---
    const formatador = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });

    // --- PARTE 1: Formatar a lista de pedidos ---
    const elementosPreco = document.querySelectorAll(".valor-para-formatar");

    elementosPreco.forEach((elemento) => {
        let valorNumerico = parseFloat(elemento.innerText);
        if (!isNaN(valorNumerico)) {
            elemento.innerText = formatador.format(valorNumerico);
        }
    });

    // --- PARTE 2: Lógica do Botão de Pagar ---
    const btnPagar = document.getElementById("btn-pagar");

    // Verifica se o botão existe na tela
    if (btnPagar) {
        
        // A) Formatação do Texto do Botão
        let valorBotao = parseFloat(btnPagar.innerText);

        if (!isNaN(valorBotao)) {
            let valorFormatado = formatador.format(valorBotao);
            btnPagar.innerText = `Pagar ${valorFormatado}`;
        }

        // --- PARTE 3: Validação (Só libera se preencher) ---
        
        // Seleciona todos os inputs que tenham a classe "campo-obrigatorio"
        const camposObrigatorios = document.querySelectorAll(".campo-obrigatorio");

        function validarFormulario() {
            let formularioValido = true;

            // Verifica cada campo
            camposObrigatorios.forEach((campo) => {
                // Se estiver vazio (sem contar espaços em branco), invalida
                if (campo.value.trim() === "") {
                    formularioValido = false;
                }
            });

            // Se for válido, disabled = false (liberado). Se não, disabled = true (bloqueado).
            btnPagar.disabled = !formularioValido;
        }

        // Adiciona o "espião" em cada campo para detectar digitação
        camposObrigatorios.forEach((campo) => {
            campo.addEventListener("input", validarFormulario);
        });

        // Roda a validação imediatamente ao carregar a página
        // (Garante que o botão comece bloqueado se os campos estiverem vazios)
        validarFormulario();
    }
});
    </script>
  </body>
</html>
